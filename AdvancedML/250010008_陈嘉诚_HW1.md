# 作业1：使用隔离森林进行空气质量异常检测

**学生：** 陈嘉诚
**学号：** 250010008

---

### 1. 异常分数-样本索引图 (Anomaly Score-Sample Index Figure)

**任务要求：** 识别被分类为异常的样本，并绘制 anomaly_score-sample_index。

**结果：**
下图展示了数据集中每个样本（按时间顺序）的异常分数。分数越低，样本越可能被视为异常。红色区域标记了被模型（`contamination=0.05`）识别为异常的样本点。

[在此处插入你运行代码后生成的 'anomaly_score_vs_sample_index.png' 图表]

![Anomaly Score Plot](anomaly_score_vs_sample_index.png)

*(注意：请确保 `anomaly_score_vs_sample_index.png` 文件与此 .md 文件位于同一目录，或者相应地更新路径)*

---

### 2. 异常样本与正常样本的特征分析

**任务要求：** 报告并比较已识别的异常样本与正常样本的特征。

**分析：**
通过运行代码，我们将样本分为“正常”（Normal）和“异常”（Anomaly）两组，并计算了它们在所有关键空气质量指标上的描述性统计数据（均值、中位数、标准差）。

**数据对比表：**

[在此处粘贴你运行 Python 脚本后输出的表格。请注意：Python 默认输出的表格不是 Markdown 格式，您可能需要手动转换或粘贴为纯文本。以下是 Markdown 格式的示例：]

| 特征 (Feature) | Normal (Mean) | Anomaly (Mean) | Normal (Median) | Anomaly (Median) | Normal (Std Dev) | Anomaly (Std Dev) |
| :--- | :--- | :--- | :--- | :--- | :--- | :--- |
| **CO(GT)** | 2.054 | 4.813 | 1.800 | 4.500 | 1.130 | 2.259 |
| **PT08.S1(CO)** | 1088.310 | 1210.154 | 1081.000 | 1201.000 | 185.088 | 221.370 |
| **NMHC(GT)** | 146.469 | 1018.906 | 98.000 | 626.500 | 137.842 | 1001.127 |
| **C6H6(GT)** | 9.531 | 20.252 | 8.200 | 19.000 | 6.533 | 10.118 |
| **PT08.S2(NMHC)**| 932.113 | 1243.208 | 907.000 | 1217.000 | 243.212 | 338.118 |
| **NOx(GT)** | 230.141 | 540.042 | 191.000 | 516.000 | 176.012 | 294.707 |
| **PT08.S3(NOx)**| 834.011 | 657.306 | 819.000 | 632.000 | 243.141 | 224.232 |
| **NO2(GT)** | 108.674 | 177.378 | 106.000 | 169.000 | 44.605 | 61.545 |
| **PT08.S4(NO2)**| 1444.205 | 1595.602 | 1429.000 | 1572.500 | 310.655 | 353.421 |
| **PT08.S5(O3)**| 1001.275 | 1198.534 | 959.000 | 1163.500 | 370.473 | 450.400 |
| **T** | 18.281 | 19.907 | 17.900 | 19.300 | 8.724 | 9.378 |
| **RH** | 48.977 | 49.529 | 49.500 | 50.000 | 17.294 | 16.511 |
| **AH** | 0.978 | 1.018 | 0.963 | 0.976 | 0.401 | 0.435 |

*(注意：以上数据为例示，请使用您自己的 Python 脚本运行结果替换)*

**分析结论：**
根据上表对比，我们可以得出以下关于异常样本的特征：

1.  **高浓度污染物：** 异常样本在多个关键污染物指标上显示出**显著更高的平均值**。例如，`NMHC(GT)`（非甲烷碳氢化合物）、`CO(GT)`（一氧化碳）和 `C6H6(GT)`（苯）的平均值在异常组中远高于正常组。
2.  **传感器读数：** 相应地，用于检测这些气体的传感器读数（如 `PT08.S1(CO)` 和 `PT08.S2(NMHC)`）在异常样本中也普遍偏高。
3.  **极端事件：** 异常样本的标准差（Std Dev）通常也更大，这表明异常组包含了更多的极端峰值读数，而不仅仅是持续的高位读数。
4.  **环境因素：** `T`（温度）和 `RH`（相对湿度）等环境因素在两组之间差异不大，这表明异常很可能由污染事件驱动，而不是由天气变化驱动。

综上所述，模型识别的“异常” 主要是指那些污染物读数（特别是碳氢化合物和一氧化碳）突然或极端升高的事件，这与“空气质量异常”的定义相符。

---

### 3. 超参数调优讨论 (Discussion of Hyperparameter Tuning)

**任务要求：** 解释选择关键超参数（`contamination`, `n_estimators`, `max_samples`）的方法，论证你的选择，并分析它们对模型性能的影响。

在本次作业中，我们使用了 Scikit-Learn 的 `IsolationForest` 实现，关键超参数选择如下：

#### a. `contamination` (污染率)

* **选择方法：** `contamination` 是一个关键参数，它告诉模型数据集中异常值的预期比例。这个值通常基于领域知识或业务需求来设定。
* **选择论证 (Justification)：** 由于没有明确的先验知识，我们选择了一个**标准的默认值 `0.05` (即 5%)**。在实际应用中，这个值需要通过领域专家（例如环境科学家）来确定，或者通过迭代分析（例如，设置为 "auto" 或尝试不同值 0.01, 0.05, 0.1）来观察哪些值捕获到的异常最有意义。选择 5% 是为了在捕获潜在异常和避免过多误报（将正常波动标记为异常）之间取得平衡。
* **性能影响：**
    * **值太高：** 会将许多正常样本错误地标记为异常，导致假阳性率（False Positive）过高。
    * **值太低：** 只会捕获最极端的异常点，可能会错过许多次要但仍然很重要的异常事件（假阴性）。

#### b. `n_estimators` (iTrees 的数量)

* **选择方法：** `n_estimators` 指的是森林中隔离树（iTree）的总数。更多的树通常会带来更稳定的模型。
* **选择论证 (Justification)：** 我们选择了 **`100`**。这是 Scikit-Learn 中的默认值，也是文献中公认的、在大多数数据集上都能提供鲁棒结果的基准值。增加这个值（例如到 200）会增加计算时间，但通常会使异常分数更加稳定和平滑，但性能（准确性）的提升在超过 100 后通常会递减。
* **性能影响：**
    * **值太低：** （例如 10）会导致模型方差很大，异常分数不稳定，结果高度依赖于随机选择了哪些树。
    * **值太高：** （例如 500）会显著增加训练时间，但对模型精度的提升很小。

#### c. `max_samples` (每棵树的样本数)

* **选择方法：** `max_samples` 控制用于构建每棵 iTree 的子样本大小。这是隔离森林算法的核心，因为它依赖于用较少的样本来“隔离”异常。
* **选择论证 (Justification)：** 我们选择了 **`256`**。隔离森林的原始论文指出，`256` 的子样本大小通常足以在不包含过多正常点的情况下隔离异常，无论数据集有多大。对于我们这个拥有数千个样本的数据集来说，`256` 提供了一个很好的平衡点，既能保持树的多样性，又能有效利用隔离机制。
* **性能影响：**
    * **值太低：** （例如 32）可能导致树“过度隔离”，使得区分复杂异常和正常样本变得困难。
    * **值太高：** （例如 "auto"，即使用所有样本）会违背隔离森林的核心思想。如果子样本太大，异常点将需要更多的分割才能被隔离，导致它们看起来与正常点无异，模型性能会急剧下降。
